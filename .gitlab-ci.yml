# GitLab CI/CD - Monorepo Tag-based Docker Build & Push
#
# 태그 규칙: {package-path}/{version}
#   예: web/react-router-spa/v2026.02.08
#
# 태그를 push하면 해당 패키지의 Dockerfile로 빌드 후
# gitlab-registry.home.codepoet.site로 push
#
# DinD 환경 참고:
#   - Runner는 DinD(Docker-in-Docker)로 빌드
#   - clone_url은 HTTP (DinD → NAS 직접, TLS 없음)
#   - Registry는 HTTPS (DinD → Mac Mini Traefik 경유, extra_hosts로 설정)

stages:
  - build

.docker-build:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    REGISTRY_URL: gitlab-registry.home.codepoet.site
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $REGISTRY_URL -u $CI_REGISTRY_USER --password-stdin

# ─────────────────────────────────────────────
# web/react-router-spa
# ─────────────────────────────────────────────
build-react-router-spa:
  extends: .docker-build
  rules:
    - if: '$CI_COMMIT_TAG =~ /^web\/react-router-spa\/v.+/'
  variables:
    PKG_DIR: web/react-router-spa
    IMAGE_NAME: ${REGISTRY_URL}/k-codepoet/my-boilerplates/web/react-router-spa
  script:
    - VERSION=${CI_COMMIT_TAG##*/}
    - echo "Building ${IMAGE_NAME}:${VERSION}"
    - docker build -t ${IMAGE_NAME}:${VERSION} -t ${IMAGE_NAME}:latest ${PKG_DIR}
    - docker push ${IMAGE_NAME}:${VERSION}
    - docker push ${IMAGE_NAME}:latest
